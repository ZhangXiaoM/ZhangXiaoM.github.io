---
title: dyld 和动态链接
date: 2018-06-28 17:46:31
tags: 
---

代码从写完到编译到运行之间发生了什么？我们的程序是如何在设备上执行的？为什么我们代码中没有的库函数也能执行？在工作中我们可能常常会疑惑这样的问题，下面我们来探究一下这些问题。

### 一、编译

编译是一个很复杂的过程，往往也是检验我们代码正确与否的第一步，编译器会帮助我们做很多很多很多事，比如，语法分析、词法分析、类型检查、预处理、生成中间代码等等，本文着重介绍链接，所以关于编译的过程也不会展开太多。那么，点了编译器的编译按钮后，编译器主要做了什么工作呢？

- 源程序分析。语法分析、词法分析、语义分析、类型检查等等，这一阶段的目标是主要是检查代码有没有错误，就像我们常见的 `error` 和 `warning` 就是这个阶段确定的。

- 预处理。预处理器会展开所有导入的头文件和替换宏定义，预处理后生成 `*.i` 文件。

- 编译。编译器将 `*.i` 文件编译成 ASCII 汇编语言文件 `*.s`。

- 汇编。汇编器将 `*.s` 文件汇编成一个可重定位的二进制目标文件`*.o`。

- 链接。链接分为动态链接和静态链接，链接器将所有的目标文件和系统目标文件组合起来，生成能在机器上运行的可执行文件。iOS 中为 `.ipa`，Windows 中为 `.exe`，Android 中为 `.apk` 等等。

例如两段 c 代码：
```c
// mian.c
#include <stdio.h>
#include "sum.h"

int main(int argc, const char * argv[]) {
    
    int arr[2] = {1, 2};
    sum(arr, 2);
    return 0;
}
```

```c
// sum.h
int sum(int *a, int n);
// sum.c
int sum(int *a, int n) {
    
    int sum = 0;
    
    for (int i = 0; i < n; ++i) {
        sum += a[i];
    }
    
    return sum;
}
```



![](https://upload-images.jianshu.io/upload_images/5314152-0407120a690cc51e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

可以看出 `stdio` 库是可以被单独编译成目标文件的，我们的源程序通过链接的形式使用 `stdio` 库中的源程序。

### 二、链接

链接就是上面的例子那样，将若干个目标文件组合成单一可执行文件的过程，这个文件被加载到内存中并执行。链接发生的时机可能为：编译时（源代码被翻译成机器代码时），加载时（程序被加载到内存中时），运行时。