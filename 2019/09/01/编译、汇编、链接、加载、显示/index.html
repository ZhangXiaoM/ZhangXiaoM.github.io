<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>  · zmc的技术博客</title><meta name="description" content=" - zmc"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="zmc的技术博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/ZhangXiaoM" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title"></h1><div class="post-info">Sep 1, 2019</div><div class="post-content"><p>之前写过关于链接的文章<a href="https://zhangxiaom.github.io/2018/07/01/dyld-%E5%92%8C%E9%93%BE%E6%8E%A5/" target="_blank" rel="noopener">dyld 和链接</a>，链接对我们了解组件化和模块化具有重要的意义。</p>
<p>我们写完的文本代码，点击了编译器上 run 按钮之后，是怎么在机器上运行的呢？另外以 iOS APP 为例的可视化应用，又是怎么将 UIView 实例在手机上显示的呢？</p>
<h3 id="前言-计算机的思考方式和人脑的思考方式"><a href="#前言-计算机的思考方式和人脑的思考方式" class="headerlink" title="前言  计算机的思考方式和人脑的思考方式"></a>前言  计算机的思考方式和人脑的思考方式</h3><p>程序 = 数据结构 + 算法，这个公式是计算机界的定理，不管使用多么高级的语言，cpp 还是 php，不管是某个领域的开发专家，还是入门级菜鸟，写出来的程序都是数据结构和算法组成的，区别无非是算法的好坏，数据结构的合适与否，设计模式也是算法的一种体现。</p>
<p>其实我们生活中充斥着各种各样的程序，比如：人吃饭（主谓宾！），人和饭即为某种数据结构，例如对象（对象在内存中的存储方式类似于结构体，一块连续的内存块），而吃的行为即是算法，算法合适与否的区别在于，用勺子吃面还是用筷子吃面。</p>
<p>我们出生以来接触的最早的一个具有科学意义的程序可能就是 1 + 1 = 2 了吧，试想一下，当我们只会用数手指计数时，计算 1 + 1，会将 1 转换为 1 根手指，我们会将这个程序转换成这种可以理解的方式，同理计算机也是一样的，它看不懂文本代码，也听不懂任何语言，它只知道高低电平（二进制），因此它也会把代码转换成它可以理解的方式–机器码。而这个转换的任务就是编译器完成的。</p>
<p>比如下面一段 c 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Sum.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFINE 3 * 5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = sum(<span class="number">3</span>, DEFINE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, c);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sum.h</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sum.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Sum.h"</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译器通过编译、汇编、链接的步骤将它转化为机器码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main:</span><br><span class="line"><span class="function">Contents <span class="title">of</span> <span class="params">(__TEXT,__text)</span> section</span></span><br><span class="line"><span class="function">0000000100000f20	55 48 89 e5 48 83 ec 20 b8 03 00 00 00 b9 0f 00 </span></span><br><span class="line"><span class="function">0000000100000f30	00 00 c7 45 fc 00 00 00 00 89 7d f8 48 89 75 f0 </span></span><br><span class="line"><span class="function">0000000100000f40	89 c7 89 ce e8 27 00 00 00 48 8d 3d 56 00 00 00 </span></span><br><span class="line"><span class="function">0000000100000f50	89 45 ec 8b 75 ec b0 00 e8 27 00 00 00 31 c9 89 </span></span><br><span class="line"><span class="function">0000000100000f60	45 e8 89 c8 48 83 c4 20 5d c3 90 90 90 90 90 90 </span></span><br><span class="line"><span class="function">0000000100000f70	55 48 89 e5 89 7d fc 89 75 f8 8b 75 fc 03 75 f8 </span></span><br><span class="line"><span class="function">0000000100000f80	89 f0 5d c3</span></span><br></pre></td></tr></table></figure>
<p>可以看出编译器的发明为程序员界带来了多大的便利性。</p>
<p>一个工程（源文件集合）是怎么转换成机器码的呢？</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/17/16681731a4b476f6?w=728&amp;h=95&amp;f=png&amp;s=16376" alt=""></p>
<p>上图即为我们写的代码转换为机器代码的全过程，这个过程很像一个流水线的工作，前一步的输出是后一步的输入。</p>
<h3 id="一、预处理"><a href="#一、预处理" class="headerlink" title="一、预处理"></a>一、预处理</h3><p>预处理的作用主要有两个：1、展开头文件；2、替换宏定义，如上述代码中的 <code>main.c</code>，经过预处理器预处理后的结果为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># <span class="number">412</span> <span class="string">"/usr/include/stdio.h"</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span></span><br><span class="line"># <span class="number">10</span> <span class="string">"main.c"</span> <span class="number">2</span></span><br><span class="line"># <span class="number">1</span> <span class="string">"./Sum.h"</span> <span class="number">1</span></span><br><span class="line"># <span class="number">14</span> <span class="string">"./Sum.h"</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sum</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"># <span class="number">11</span> <span class="string">"main.c"</span> <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> c = sum(<span class="number">3</span>, <span class="number">3</span> * <span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, c);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，展开了 <code>Sum.h</code>，替换了宏定义 <code>DEFINE</code>。（上述代码省略了展开的标准io库头文件）</p>
<h3 id="二、编译"><a href="#二、编译" class="headerlink" title="二、编译"></a>二、编译</h3><p>预处理后的 <code>main.i</code> 文件作为输入文件输入到编译器编译，编译器有前后端之分：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/17/1668173568173b8b?w=466&amp;h=67&amp;f=png&amp;s=4722" alt=""></p>
<p>编译的过程也是一种流水线的过程，前一步的输出作为后一步的输入，最后得到结果。<br>典型的例子就是 clang 和 llvm，编译器前端的作用是词法分析、语法分析等，保证代码没有错误，比如，变量未声明、标识符错误、漏写分隔符和括号等语法问题，而编译器后端的任务是通过复杂的寄存器分配算法，为代码中的变量和常量分配合适的寄存器，然后生成并优化汇编指令。</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/17/16681741b3051f4d?w=543&amp;h=178&amp;f=png&amp;s=19281" alt=""></p>
<p><code>*.i</code> 中存储的我们的代码是一种字符流的形式，词法分析器会将字符流转换为记号流，举个栗子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (x &gt; <span class="number">5</span>)</span><br><span class="line">    y = <span class="string">"h"</span>;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">    z = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>经过词法分析器分析后得到的记号流为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">IF LPAREN <span class="title">IDENT</span><span class="params">(x)</span> GT <span class="title">INT</span><span class="params">(<span class="number">5</span>)</span> RPAREN</span></span><br><span class="line"><span class="function">    <span class="title">IDENT</span><span class="params">(y)</span> ASSIGN <span class="title">STRING</span><span class="params">(<span class="string">"h"</span>)</span> SEMICOLON</span></span><br><span class="line"><span class="function">ELSE</span></span><br><span class="line"><span class="function">    <span class="title">IDENT</span><span class="params">(z)</span> ASSIGN <span class="title">INT</span><span class="params">(<span class="number">1</span>)</span> SEMICOLON EOF</span></span><br></pre></td></tr></table></figure>
<p>词法分析只是简单的将字符流转换为记号流，比如将标识符、关键字、括号、分隔符等转换成相应的记号，而判断我们程序是否有语法错误是语法分析器做的事，比如写代码的时候漏写了一个括号，词法分析器不会报错，只是在产生的记号流中，少了一个括号的记号，语法分析器会将报错信息反馈给我们，告诉我们，哪里应该有一个括号。语法错误我们平常写代码过程中经常遇到的问题。<br>语法分析器除了会帮我们分析语法是否符合规范之外，还有一个作用就是生成抽象语法树，比如上述例子中，语法分析器生成的抽象语法树为：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/17/1668177c71e5db2f?w=330&amp;h=203&amp;f=png&amp;s=9680" alt=""></p>
<p>编译器后端会通过使用抽象语法树经过一系列的算法生成汇编指令，由于寄存器分配，指令优化等算法过于高深，此处不再分析。</p>
<p>第一个例子中的 <code>main.c</code>，我们可以通过反汇编得到机器码对应的汇编指令为：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">0</span>: <span class="number">55</span>  	               <span class="keyword">pushq	</span>%rbp</span><br><span class="line"> <span class="number">1</span>:	<span class="number">48</span> <span class="number">89</span> e5 	        <span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"> <span class="number">4</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>          	<span class="keyword">subq	</span><span class="number">$32</span>, %rsp</span><br><span class="line"> <span class="number">8</span>:	<span class="keyword">b8 </span><span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">movl	</span><span class="number">$3</span>, %eax</span><br><span class="line"> d:	<span class="keyword">b9 </span><span class="number">0</span>f <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	<span class="keyword">movl	</span><span class="number">$15</span>, %ecx</span><br><span class="line"><span class="number">12</span>:	<span class="built_in">c7</span> <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	<span class="keyword">movl	</span><span class="number">$0</span>, -<span class="number">4</span>(%rbp)</span><br><span class="line"><span class="number">19</span>:	<span class="number">89</span> <span class="number">7</span>d f8 	        <span class="keyword">movl </span>	%edi, -<span class="number">8</span>(%rbp)</span><br><span class="line"><span class="number">1</span>c:	<span class="number">48</span> <span class="number">89</span> <span class="number">75</span> <span class="built_in">f0</span> 	        <span class="keyword">movq </span>	%rsi, -<span class="number">16</span>(%rbp)</span><br><span class="line"><span class="number">20</span>:	<span class="number">89</span> <span class="built_in">c7</span> 	                <span class="keyword">movl </span>	%eax, %edi</span><br><span class="line"><span class="number">22</span>:	<span class="number">89</span> ce 	                <span class="keyword">movl	</span>%ecx, %esi</span><br><span class="line"><span class="number">24</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	       callq	<span class="number">0</span> &lt;_main+<span class="number">0x29</span>&gt;</span><br><span class="line"><span class="number">29</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">3</span>d <span class="number">1</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	leaq	<span class="number">26</span>(%rip), %rdi</span><br><span class="line"><span class="number">30</span>:	<span class="number">89</span> <span class="number">45</span> ec 	        <span class="keyword">movl	</span>%eax, -<span class="number">20</span>(%rbp)</span><br><span class="line"><span class="number">33</span>:	<span class="number">8</span>b <span class="number">75</span> ec 	        <span class="keyword">movl	</span>-<span class="number">20</span>(%rbp), %esi</span><br><span class="line"><span class="number">36</span>:	<span class="keyword">b0 </span><span class="number">00</span>                	<span class="keyword">movb	</span><span class="number">$0</span>, %al</span><br><span class="line"><span class="number">38</span>:	e8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	       callq	<span class="number">0</span> &lt;_main+<span class="number">0x3D</span>&gt;</span><br><span class="line"><span class="number">3</span>d:	<span class="number">31</span> <span class="built_in">c9</span>                	xorl 	%ecx, %ecx</span><br><span class="line"><span class="number">3</span>f:	<span class="number">89</span> <span class="number">45</span> e8             	<span class="keyword">movl </span>	%eax, -<span class="number">24</span>(%rbp)</span><br><span class="line"><span class="number">42</span>:	<span class="number">89</span> <span class="built_in">c8</span> 	                <span class="keyword">movl	</span>%ecx, %eax</span><br><span class="line"><span class="number">44</span>:	<span class="number">48</span> <span class="number">83</span> <span class="built_in">c4</span> <span class="number">20</span>          	<span class="keyword">addq </span>	<span class="number">$32</span>, %rsp</span><br><span class="line"><span class="number">48</span>:	<span class="number">5</span>d                      <span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">49</span>:	<span class="built_in">c3</span> 	                retq</span><br></pre></td></tr></table></figure></p>
<h4 id="一个简单的编译器的例子"><a href="#一个简单的编译器的例子" class="headerlink" title="*一个简单的编译器的例子"></a>*一个简单的编译器的例子</h4><p>某种简单的加法计算器，只接受两种指令 <code>push</code> 和 <code>add</code>，<code>push</code> 是压栈操作，<code>add</code> 是将栈顶两个元素弹出相加并将结果压栈。<br>那么当我们输入程序 <code>1 + 2 + 3</code> 时，它的编译过程为：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/17/166819e2e514d18e?w=693&amp;h=112&amp;f=png&amp;s=10367" alt=""></p>
<p>生成的指令：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">push </span><span class="number">1</span></span><br><span class="line"><span class="keyword">push </span><span class="number">2</span></span><br><span class="line"><span class="keyword">add</span></span><br><span class="line"><span class="keyword">push </span><span class="number">3</span></span><br><span class="line"><span class="keyword">add</span></span><br><span class="line"><span class="keyword">ret</span></span><br></pre></td></tr></table></figure>
<h3 id="三、汇编"><a href="#三、汇编" class="headerlink" title="三、汇编"></a>三、汇编</h3><p>汇编器将汇编指令汇编成机器代码。</p>
<h3 id="四、链接"><a href="#四、链接" class="headerlink" title="四、链接"></a>四、链接</h3><p>参见 <a href="https://zhangxiaom.github.io/2018/07/01/dyld-%E5%92%8C%E9%93%BE%E6%8E%A5/" target="_blank" rel="noopener">dyld 和链接</a>。</p>
<h4 id="补充："><a href="#补充：" class="headerlink" title="*补充："></a>*补充：</h4><p>首先需要知道的是，函数（区分函数指针）是一段指令块，被分配在可执行文件的某块内存中。</p>
<p>我们工程中的每个源文件都被编译器编译成后缀为 <code>.o</code> 的目标文件（object file），试想一下上面的例子中，<code>main.i</code> 中仅仅得到了 <code>sum()</code> 的声明，因此 <code>main.o</code> 中也仅存在 <code>sum()</code> 的声明，那么 <code>sum()</code> 的指令集是怎么执行的呢？这就是链接的作用了，其实整个代码的编译过程中，有一个叫<strong>符号表</strong>的东西起了很大的作用，符号表以键值对的形式存储了当前工程中所有源文件的外部符号，比如上面的例子中，<code>_sum</code> 即为符号（键），<code>*_sum</code> 即为符号的引用（指向 <code>sum()</code> 指令块的指针，值）。</p>
<p>语法分析器拿到 <code>sum</code> 记号时，它会从当前文件（<code>main.i</code>）中寻找 <code>sum</code> 的定义，这个定义可能是从别的头文件展开的，也可能是该文件本身定义的，当不存在时就会报语法错误。然后编译器后端分析抽象语法树时，会将当前函数的指令预设置为下一条指令。比如</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">// 上个例子中的 Sum.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"Sum.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// insert code here...</span></span><br><span class="line">    foo();</span><br><span class="line">    sum(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成的目标文件 <code>main.o</code> 中的指令为：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">main.o</span>:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line"><span class="symbol">_foo</span>:</span><br><span class="line"><span class="number">0000000000000000</span>	<span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000001</span>	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000000000004</span>	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000005</span>	retq</span><br><span class="line"><span class="number">0000000000000006</span>	<span class="keyword">nopw	</span>%cs:(%rax,%rax)</span><br><span class="line"><span class="symbol">_main</span>:</span><br><span class="line"><span class="number">0000000000000010</span>	<span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000011</span>	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000000000014</span>	<span class="keyword">subq	</span><span class="number">$0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000000000018</span>	<span class="keyword">movl	</span><span class="number">$0x0</span>, -<span class="number">0x4</span>(%rbp)</span><br><span class="line"><span class="number">000000000000001</span>f	<span class="keyword">movl	</span>%edi, -<span class="number">0x8</span>(%rbp)</span><br><span class="line"><span class="number">0000000000000022</span>	<span class="keyword">movq	</span>%rsi, -<span class="number">0x10</span>(%rbp)</span><br><span class="line"><span class="number">0000000000000026</span>	callq	<span class="number">0x2b</span></span><br><span class="line"><span class="number">000000000000002</span>b	<span class="keyword">movl	</span><span class="number">$0x1</span>, %edi</span><br><span class="line"><span class="number">0000000000000030</span>	<span class="keyword">movl	</span><span class="number">$0x2</span>, %esi</span><br><span class="line"><span class="number">0000000000000035</span>	callq	<span class="number">0x3a</span></span><br><span class="line"><span class="number">000000000000003</span>a	xorl	%esi, %esi</span><br><span class="line"><span class="number">000000000000003</span>c	<span class="keyword">movl	</span>%eax, -<span class="number">0x14</span>(%rbp)</span><br><span class="line"><span class="number">000000000000003</span>f	<span class="keyword">movl	</span>%esi, %eax</span><br><span class="line"><span class="number">0000000000000041</span>	<span class="keyword">addq	</span><span class="number">$0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000000000045</span>	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000046</span>	retq</span><br></pre></td></tr></table></figure>
<p>可以看到 <code>main.o</code> 中并没有 <code>sum</code> 函数。此时符号表中存储的的符号为 <code>_sum</code>，此时的 <code>Sum.o</code>：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">Sum.o</span>:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line"><span class="symbol">_sum</span>:</span><br><span class="line"><span class="number">0000000000000000</span>	<span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000001</span>	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000000000004</span>	<span class="keyword">movl	</span>%edi, -<span class="number">0x4</span>(%rbp)</span><br><span class="line"><span class="number">0000000000000007</span>	<span class="keyword">movl	</span>%esi, -<span class="number">0x8</span>(%rbp)</span><br><span class="line"><span class="number">000000000000000</span>a	<span class="keyword">movl	</span>-<span class="number">0x4</span>(%rbp), %esi</span><br><span class="line"><span class="number">000000000000000</span>d	<span class="keyword">addl	</span>-<span class="number">0x8</span>(%rbp), %esi</span><br><span class="line"><span class="number">0000000000000010</span>	<span class="keyword">movl	</span>%esi, %eax</span><br><span class="line"><span class="number">0000000000000012</span>	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000000000013</span>	retq</span><br></pre></td></tr></table></figure>
<p>链接器会将 <code>Sum.o</code> 和 <code>main.o</code> 链接成一个可执行文件，当需要调用 <code>sum</code> 函数时，链接器会去符号表中找 <code>_sum</code> 符号，如果找不到编译器就会报链接错误，如果找到，链接器通过 <code>_sum</code> 键找到指向 <code>sum</code> 指令块的指针，然后将 <code>sum</code> 指令块重新布局到可执行文件的内存中，此时的 <code>callq</code> 指令会调用重新定义后的内存地址。</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">main</span>:</span><br><span class="line">(__TEXT,__text) section</span><br><span class="line"><span class="symbol">_foo</span>:</span><br><span class="line"><span class="number">0000000100000</span>f50	<span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>f51	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000100000</span>f54	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>f55	retq</span><br><span class="line"><span class="number">0000000100000</span>f56	<span class="keyword">nopw	</span>%cs:(%rax,%rax)</span><br><span class="line"><span class="symbol">_main</span>:</span><br><span class="line"><span class="number">0000000100000</span>f60	<span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>f61	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000100000</span>f64	<span class="keyword">subq	</span><span class="number">$0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000100000</span>f68	<span class="keyword">movl	</span><span class="number">$0x0</span>, -<span class="number">0x4</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>f6f	<span class="keyword">movl	</span>%edi, -<span class="number">0x8</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>f72	<span class="keyword">movq	</span>%rsi, -<span class="number">0x10</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>f76	callq	<span class="number">0x100000f50</span> // foo 函数首地址</span><br><span class="line"><span class="number">0000000100000</span>f7b	<span class="keyword">movl	</span><span class="number">$0x1</span>, %edi</span><br><span class="line"><span class="number">0000000100000</span>f80	<span class="keyword">movl	</span><span class="number">$0x2</span>, %esi</span><br><span class="line"><span class="number">0000000100000</span>f85	callq	<span class="number">0x100000fa0</span> // sum 函数首地址</span><br><span class="line"><span class="number">0000000100000</span>f8a	xorl	%esi, %esi</span><br><span class="line"><span class="number">0000000100000</span>f8c	<span class="keyword">movl	</span>%eax, -<span class="number">0x14</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>f8f	<span class="keyword">movl	</span>%esi, %eax</span><br><span class="line"><span class="number">0000000100000</span>f91	<span class="keyword">addq	</span><span class="number">$0x20</span>, %rsp</span><br><span class="line"><span class="number">0000000100000</span>f95	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>f96	retq</span><br><span class="line"><span class="number">0000000100000</span>f97	<span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f98	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f99	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9a	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9b	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9c	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9d	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9e	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">0000000100000f9f	</span><span class="keyword">nop</span></span><br><span class="line"><span class="keyword">_sum:</span></span><br><span class="line"><span class="keyword">0000000100000fa0	</span><span class="keyword">pushq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>fa1	<span class="keyword">movq	</span>%rsp, %rbp</span><br><span class="line"><span class="number">0000000100000</span>fa4	<span class="keyword">movl	</span>%edi, -<span class="number">0x4</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>fa7	<span class="keyword">movl	</span>%esi, -<span class="number">0x8</span>(%rbp)</span><br><span class="line"><span class="number">0000000100000</span>faa	<span class="keyword">movl	</span>-<span class="number">0x4</span>(%rbp), %esi</span><br><span class="line"><span class="number">0000000100000</span>fad	<span class="keyword">addl	</span>-<span class="number">0x8</span>(%rbp), %esi</span><br><span class="line"><span class="number">0000000100000</span>fb0	<span class="keyword">movl	</span>%esi, %eax</span><br><span class="line"><span class="number">0000000100000</span>fb2	<span class="keyword">popq	</span>%rbp</span><br><span class="line"><span class="number">0000000100000</span>fb3	retq</span><br></pre></td></tr></table></figure>
<p>这就是静态链接过程中，静态链接器的工作。</p>
<p>但是 iOS 开发中方法的调用会更复杂，涉及到 <code>runtime</code> 和 dyld，大致流程为：</p>
<p><img src="https://user-gold-cdn.xitu.io/2018/10/19/1668b86b12e208f4?w=648&amp;h=360&amp;f=png&amp;s=31407" alt=""></p>
<p>上图中，dyld 会将 <code>0xyy</code> 重定向为 <code>objc_msgSend()</code> 指令块的地址（运行时完成，动态链接）。<code>- foo</code> 的首地址被存储在名为 <code>Foo</code> 的类对象中（类似于 C++ 的虚函数表）。然后该指令块会在运行时被调用。<a href="https://zhangxiaom.github.io/2018/01/20/%E4%BB%8Eruntime%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E7%9A%84%E5%8A%A8%E6%80%81%E6%80%A7/" target="_blank" rel="noopener">了解更多</a></p>
<h3 id="五、加载"><a href="#五、加载" class="headerlink" title="五、加载"></a>五、加载</h3><p>dyld 会将链接完成的可执行文件加载到内存中：</p>
<ul>
<li>将 <code>__TEXT,__text</code> 中的指令拷贝到虚拟内存的 <code>.rodata（readonly）</code> 中。</li>
<li>将 <code>__DATA,__data</code> 中的全局和静态变量拷贝到虚拟内存的 <code>.rwdata （readwrite）</code>中。</li>
<li>使用 <code>.symbol</code> 中的符号完成动态链接。</li>
<li>初始化堆栈，从 <code>main()</code> 函数开始执行程序。</li>
</ul>
<p>其中涉及到的 <code>+ load</code> 函数，参见 <a href="https://zhangxiaom.github.io/2018/07/01/dyld-%E5%92%8C%E9%93%BE%E6%8E%A5/" target="_blank" rel="noopener">dyld 和链接</a>。</p>
<h3 id="六、显示"><a href="#六、显示" class="headerlink" title="六、显示"></a>六、显示</h3><p>参见<a href="https://zhangxiaom.github.io/" target="_blank" rel="noopener">优化APP的显示性能</a>。</p>
<h3 id="七、结语"><a href="#七、结语" class="headerlink" title="七、结语"></a>七、结语</h3><p>现在知道我们写完的代码是怎么转换成机器能明白的语言了吧。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/07/21/优化APP的显示性能/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2019 <a href="http://yoursite.com">zmc</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>